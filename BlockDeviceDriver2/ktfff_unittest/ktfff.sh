#!/bin/bash
source lib/config.sh
source lib/install.sh
source lib/makefile.sh
source lib/unittest.sh

#####################################################
#               Ktfff Unittest Tool                 #
#                                                   #
#   install - install ktf framework                 #
#   run - build && run all unittest                 #
#   run <test file> - build && run single unittest  #
#                                                   #
#####################################################

function clean_env()
{
    ktfff_info "KTFFF CLEAN"
    sudo /bin/rm -rf BlockDeviceDaemon
    sudo /bin/rm -rf *.o *.ko *.symvers *.mod.c .*.cmd Module.markers modules.order .tmp_versions version.h
    sudo /bin/rm -rf *.ko
    sudo /bin/rm -rf Makefile
    sudo /bin/rm -rf $unitM_temp_dir
    sudo /bin/rm -rf $unitMK_temp_dir
    sudo /bin/rm -rf $unit_output_dir
}

function ktfff_info()
{
    local info_str=$1
    Col='\e[0m'
    BIBlu='\e[0;96m'
    printf "\n${BIBlu}[INFO] ${Col}$info_str \n"
}

function unittest_main()
{
    mkdir -p $unitM_temp_dir
    mkdir -p $unitMK_temp_dir
    mkdir -p $unit_output_dir

    # build_user_daemon
    ktfff_info "BUILDING KERNEL MODULE"
    build_all_kern_module
    ktfff_info "UNNITEST START"
    unittest_start
    ktfff_info "UNNITEST COMPLETE"
}

function unittest_check()
{
    local cmd_lsit=$@
    local test_list=()
    local suite_list=()

    for cmd in $cmd_lsit; do
        if [[ $cmd = *"--test"* ]]; then
            test_case=${cmd##*=}
            test_list+=($test_case)
        elif [[ $cmd = *"--suite"* ]]; then
            suite_file=${cmd##*=}
            suite_list+=($suite_file)
        else
            printf "Unknown arguments: $cmd\n"
            usage
        fi
    done
}

export LANG=en_US


# --- Command line help -------------------------------------------
function usage()
{
    echo -e "\nUsage: $0 [argument...]"
    echo
    echo -e "  install                      install ktfff (gtest, ktf)."
    echo -e "  run                          build all kernel module and run all unittest case."
    echo -e "  run <test file>              build specific kernel module and run specific unittest case."
    echo -e "  clean                        remove all file generated by ktfff."
    echo -e "  -h, --help                   display this help text and exit."
    echo
    exit 1
}

# --- Ktfff main --------------------------------------------------
while [ "$#" ]; do
    case $1 in
        install )
            shift
            ktfff_info "KTFFF INSTALL\n"
            ktfff_setup
            exit
            ;;
        run )
            shift
            # if [ $# -gt 0 ]; then
                # only run the specific test case 
            # fi
            # echo $@
            unittest_check $@
            # clean_env
            # unittest_main
            exit
            ;;
        clean )
            shift
            clean_env
            exit
            ;;
        -h | --help )
            usage
            ;;
        * )
            usage
    esac
    shift
done 